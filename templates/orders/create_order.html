{% extends 'base.html' %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ - Tutors Platform{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</h1>
        
        <form 
            hx-post="/api/orders/"
            hx-trigger="submit"
            hx-target="#order-form-container"
            hx-swap="outerHTML"
            hx-indicator="#loading"
            data-success-message="–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
            class="space-y-6"
        >
            {% csrf_token %}
            
            <div id="order-form-container">
                <!-- Subject Selection -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
                        –ü—Ä–µ–¥–º–µ—Ç *
                    </label>
                    <select 
                        name="subject" 
                        id="subject" 
                        required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        hx-get="/api/subjects/search/"
                        hx-trigger="change"
                        hx-target="#subject-description"
                    >
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                    <div id="subject-description" class="mt-2 text-sm text-gray-500"></div>
                </div>

                <!-- Title -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–∫–∞–∑–∞ *
                    </label>
                    <input 
                        type="text" 
                        name="title" 
                        id="title" 
                        required
                        maxlength="200"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∏–∑—É—á–µ–Ω–∏–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *
                    </label>
                    <textarea 
                        name="description" 
                        id="description" 
                        rows="4" 
                        required
                        placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ, —Å —á–µ–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —Ü–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    ></textarea>
                    <p class="mt-1 text-sm text-gray-500">–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–º –ª—É—á—à–µ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—ã —Å–º–æ–≥—É—Ç –æ—Ü–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</p>
                </div>

                <!-- Budget -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="budget_min" class="block text-sm font-medium text-gray-700 mb-2">
                            –ë—é–¥–∂–µ—Ç –æ—Ç (—Ä—É–±/—á–∞—Å) *
                        </label>
                        <input 
                            type="number" 
                            name="budget_min" 
                            id="budget_min" 
                            required
                            min="0"
                            step="50"
                            placeholder="1000"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                    <div>
                        <label for="budget_max" class="block text-sm font-medium text-gray-700 mb-2">
                            –ë—é–¥–∂–µ—Ç –¥–æ (—Ä—É–±/—á–∞—Å) *
                        </label>
                        <input 
                            type="number" 
                            name="budget_max" 
                            id="budget_max" 
                            required
                            min="0"
                            step="50"
                            placeholder="2000"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                </div>

                <!-- Format -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        –§–æ—Ä–º–∞—Ç –∑–∞–Ω—è—Ç–∏–π *
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input 
                                type="checkbox" 
                                name="format_online" 
                                value="true"
                                checked
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            />
                            <span class="ml-2 text-sm text-gray-900">–û–Ω–ª–∞–π–Ω</span>
                        </label>
                        <label class="flex items-center">
                            <input 
                                type="checkbox" 
                                name="format_offline" 
                                value="true"
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                hx-trigger="change"
                                hx-target="#location-fields"
                                hx-swap="innerHTML"
                                hx-get="/fragments/location_fields/"
                            />
                            <span class="ml-2 text-sm text-gray-900">–û—á–Ω–æ</span>
                        </label>
                    </div>
                </div>

                <!-- Location (conditionally shown) -->
                <div id="location-fields"></div>

                <!-- Schedule -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        –ñ–µ–ª–∞–µ–º–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                    </label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <select 
                                name="schedule_days" 
                                multiple
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="monday">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                                <option value="tuesday">–í—Ç–æ—Ä–Ω–∏–∫</option>
                                <option value="wednesday">–°—Ä–µ–¥–∞</option>
                                <option value="thursday">–ß–µ—Ç–≤–µ—Ä–≥</option>
                                <option value="friday">–ü—è—Ç–Ω–∏—Ü–∞</option>
                                <option value="saturday">–°—É–±–±–æ—Ç–∞</option>
                                <option value="sunday">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
                            </select>
                        </div>
                        <div>
                            <select 
                                name="schedule_time"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">–í—Ä–µ–º—è</option>
                                <option value="morning">–£—Ç—Ä–æ–º (9:00-12:00)</option>
                                <option value="afternoon">–î–Ω–µ–º (12:00-17:00)</option>
                                <option value="evening">–í–µ—á–µ—Ä–æ–º (17:00-21:00)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- AI Matching Option -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="use_ai_matching" 
                            name="use_ai_matching"
                            value="true"
                            checked
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                        />
                        <label for="use_ai_matching" class="ml-2 text-sm font-medium text-gray-900">
                            ü§ñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ò–ò-–ø–æ–¥–±–æ—Ä —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤
                        </label>
                    </div>
                    <p class="mt-1 text-sm text-gray-600">
                        –ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                    </p>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex items-center justify-between pt-6">
                <button 
                    type="button"
                    onclick="history.back()"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                    –û—Ç–º–µ–Ω–∞
                </button>
                
                <div class="flex items-center space-x-4">
                    <div id="loading" class="htmx-indicator">
                        <div class="flex items-center text-sm text-gray-500">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...
                        </div>
                    </div>
                    
                    <button 
                        type="submit"
                        class="px-6 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- AI Matching Results Modal -->
<div id="ai-matching-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-96 overflow-hidden">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">ü§ñ –ò–ò –Ω–∞—à–µ–ª –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤</h3>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="ai-results-container" class="space-y-4 max-h-80 overflow-y-auto">
                <!-- AI results will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    document.getElementById('budget_max').addEventListener('input', function() {
        const minBudget = parseInt(document.getElementById('budget_min').value);
        const maxBudget = parseInt(this.value);
        
        if (maxBudget && minBudget && maxBudget < minBudget) {
            this.setCustomValidity('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ');
        } else {
            this.setCustomValidity('');
        }
    });

    // Handle successful order creation
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful && event.detail.xhr.status === 201) {
            const response = JSON.parse(event.detail.xhr.responseText);
            const useAI = document.getElementById('use_ai_matching').checked;
            
            if (useAI) {
                // Show AI matching results
                loadAIMatches(response.id);
            } else {
                // Redirect to order page
                window.location.href = `/orders/${response.id}/`;
            }
        }
    });

    // Load AI matches
    function loadAIMatches(orderId) {
        document.getElementById('ai-matching-modal').classList.remove('hidden');
        
        fetch('/api/ml/match/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                order_id: orderId,
                limit: 5
            })
        })
        .then(response => response.json())
        .then(data => {
            displayAIResults(data.matches, orderId);
        })
        .catch(error => {
            console.error('AI matching failed:', error);
            closeAIModal();
            showNotification('–ò–ò-–ø–æ–¥–±–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
        });
    }

    // Display AI results
    function displayAIResults(matches, orderId) {
        const container = document.getElementById('ai-results-container');
        
        if (!matches || matches.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">–ò–ò –Ω–µ –Ω–∞—à–µ–ª –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞.</p>';
            return;
        }

        container.innerHTML = matches.map(match => `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <h4 class="font-medium text-gray-900">${match.profile.name}</h4>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${Math.round(match.score * 100)}% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                            </span>
                        </div>
                        <div class="mt-1 flex items-center space-x-4 text-sm text-gray-500">
                            <span>‚≠ê ${match.profile.rating}/5</span>
                            <span>üìö ${match.profile.experience_years} –ª–µ—Ç –æ–ø—ã—Ç–∞</span>
                        </div>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">
                                <strong>–ü–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç:</strong> ${match.reasons.join(', ')}
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <button 
                            onclick="inviteTutor(${match.tutor_id}, ${orderId})"
                            class="px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700"
                        >
                            –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                        </button>
                        <a href="/tutors/${match.tutor_id}/" class="text-blue-600 hover:text-blue-700 text-sm">
                            –ü—Ä–æ—Ñ–∏–ª—å
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Close AI modal
    function closeAIModal() {
        document.getElementById('ai-matching-modal').classList.add('hidden');
        // Redirect to orders list
        window.location.href = '/orders/';
    }

    // Invite tutor
    function inviteTutor(tutorId, orderId) {
        // This would send an invitation to the tutor
        showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—É!', 'success');
    }
</script>
{% endblock %}