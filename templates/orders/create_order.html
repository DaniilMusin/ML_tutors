{% extends 'base.html' %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ - Tutors Platform{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="{ 
    currentStep: 1, 
    totalSteps: 4,
    formData: {
        subject: '',
        title: '',
        description: '',
        budget_min: '',
        budget_max: '',
        format_online: true,
        format_offline: false,
        use_ai_matching: true
    }
}">
    <!-- Progress Bar -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞</h1>
            <div class="text-sm text-gray-500 dark:text-gray-400">
                –®–∞–≥ <span x-text="currentStep"></span> –∏–∑ <span x-text="totalSteps"></span>
            </div>
        </div>
        
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full transition-all duration-300"
                 :style="`width: ${(currentStep / totalSteps) * 100}%`"></div>
        </div>
        
        <div class="flex justify-between mt-2 text-xs text-gray-500 dark:text-gray-400">
            <span>–ü—Ä–µ–¥–º–µ—Ç</span>
            <span>–î–µ—Ç–∞–ª–∏</span>
            <span>–ë—é–¥–∂–µ—Ç</span>
            <span>–§–æ—Ä–º–∞—Ç</span>
        </div>
    </div>

    <form 
        hx-post="/api/orders/"
        hx-trigger="submit"
        hx-target="#order-form-container"
        hx-swap="outerHTML"
        hx-indicator="#loading"
        data-success-message="–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
        class="space-y-8"
    >
        {% csrf_token %}
        
        <div id="order-form-container">
            <!-- Step 1: Subject Selection -->
            <div x-show="currentStep === 1" class="slide-up">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="book-open" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</h2>
                            <p class="text-gray-600 dark:text-gray-400">–£–∫–∞–∂–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <label for="subject" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                            –ü—Ä–µ–¥–º–µ—Ç *
                        </label>
                        <select 
                            name="subject" 
                            id="subject" 
                            required
                            x-model="formData.subject"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            hx-get="/api/subjects/search/"
                            hx-trigger="change"
                            hx-target="#subject-description"
                        >
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                            {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.name }}</option>
                            {% endfor %}
                        </select>
                        <div id="subject-description" class="mt-2 text-sm text-gray-500 dark:text-gray-400"></div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <div></div>
                        <button 
                            type="button"
                            @click="currentStep = 2"
                            :disabled="!formData.subject"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
                        >
                            <span>–î–∞–ª–µ–µ</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Order Details -->
            <div x-show="currentStep === 2" class="slide-up">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="file-text" class="w-5 h-5 text-green-600 dark:text-green-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
                            <p class="text-gray-600 dark:text-gray-400">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∑–∞–¥–∞—á—É –∏ —Ü–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–∫–∞–∑–∞ *
                            </label>
                            <input 
                                type="text" 
                                name="title" 
                                id="title" 
                                required
                                maxlength="200"
                                x-model="formData.title"
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∏–∑—É—á–µ–Ω–∏–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                            <div class="flex justify-between mt-1">
                                <p class="text-sm text-gray-500 dark:text-gray-400">–ß–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫, —Ç–µ–º –ª—É—á—à–µ</p>
                                <span class="text-sm text-gray-400" x-text="formData.title.length + '/200'"></span>
                            </div>
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *
                            </label>
                            <textarea 
                                name="description" 
                                id="description" 
                                rows="6" 
                                required
                                x-model="formData.description"
                                placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ, —Å —á–µ–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, —Ü–µ–ª–∏ –æ–±—É—á–µ–Ω–∏—è, –∂–µ–ª–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                            ></textarea>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–º –ª—É—á—à–µ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—ã —Å–º–æ–≥—É—Ç –æ—Ü–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button 
                            type="button"
                            @click="currentStep = 1"
                            class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors flex items-center space-x-2"
                        >
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            <span>–ù–∞–∑–∞–¥</span>
                        </button>
                        
                        <button 
                            type="button"
                            @click="currentStep = 3"
                            :disabled="!formData.title || !formData.description"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
                        >
                            <span>–î–∞–ª–µ–µ</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Budget -->
            <div x-show="currentStep === 3" class="slide-up">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">–ë—é–¥–∂–µ—Ç</h2>
                            <p class="text-gray-600 dark:text-gray-400">–£–∫–∞–∂–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞ —á–∞—Å –∑–∞–Ω—è—Ç–∏–π</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="budget_min" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    –ë—é–¥–∂–µ—Ç –æ—Ç (—Ä—É–±/—á–∞—Å) *
                                </label>
                                <div class="relative">
                                    <input 
                                        type="number" 
                                        name="budget_min" 
                                        id="budget_min" 
                                        required
                                        min="0"
                                        step="50"
                                        x-model="formData.budget_min"
                                        placeholder="1000"
                                        class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    />
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">‚ÇΩ</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="budget_max" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    –ë—é–¥–∂–µ—Ç –¥–æ (—Ä—É–±/—á–∞—Å) *
                                </label>
                                <div class="relative">
                                    <input 
                                        type="number" 
                                        name="budget_max" 
                                        id="budget_max" 
                                        required
                                        min="0"
                                        step="50"
                                        x-model="formData.budget_max"
                                        placeholder="2000"
                                        class="w-full pl-10 pr-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    />
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">‚ÇΩ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Budget validation message -->
                        <div x-show="formData.budget_min && formData.budget_max && parseInt(formData.budget_max) < parseInt(formData.budget_min)" 
                             class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                            <div class="flex items-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 dark:text-red-400 mr-2"></i>
                                <span class="text-red-800 dark:text-red-200">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ</span>
                            </div>
                        </div>
                        
                        <!-- Budget suggestions -->
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±—é–¥–∂–µ—Ç—É:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                <div class="bg-white dark:bg-gray-800 rounded p-3">
                                    <div class="font-medium text-gray-900 dark:text-white">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
                                    <div class="text-gray-600 dark:text-gray-400">500-1500 ‚ÇΩ/—á–∞—Å</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded p-3">
                                    <div class="font-medium text-gray-900 dark:text-white">–û–ø—ã—Ç–Ω—ã–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</div>
                                    <div class="text-gray-600 dark:text-gray-400">1500-3000 ‚ÇΩ/—á–∞—Å</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded p-3">
                                    <div class="font-medium text-gray-900 dark:text-white">–≠–∫—Å–ø–µ—Ä—Ç—ã</div>
                                    <div class="text-gray-600 dark:text-gray-400">3000+ ‚ÇΩ/—á–∞—Å</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button 
                            type="button"
                            @click="currentStep = 2"
                            class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors flex items-center space-x-2"
                        >
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            <span>–ù–∞–∑–∞–¥</span>
                        </button>
                        
                        <button 
                            type="button"
                            @click="currentStep = 4"
                            :disabled="!formData.budget_min || !formData.budget_max || parseInt(formData.budget_max) < parseInt(formData.budget_min)"
                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center space-x-2"
                        >
                            <span>–î–∞–ª–µ–µ</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Format and Final -->
            <div x-show="currentStep === 4" class="slide-up">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="settings" class="w-5 h-5 text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">–§–æ—Ä–º–∞—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <p class="text-gray-600 dark:text-gray-400">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–Ω—è—Ç–∏–π –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Format -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                –§–æ—Ä–º–∞—Ç –∑–∞–Ω—è—Ç–∏–π *
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="relative flex items-center p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <input 
                                        type="checkbox" 
                                        name="format_online" 
                                        value="true"
                                        x-model="formData.format_online"
                                        checked
                                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    />
                                    <div class="ml-3">
                                        <div class="flex items-center">
                                            <i data-lucide="video" class="w-5 h-5 text-blue-600 mr-2"></i>
                                            <span class="font-medium text-gray-900 dark:text-white">–û–Ω–ª–∞–π–Ω</span>
                                        </div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">–ó–∞–Ω—è—Ç–∏—è –ø–æ –≤–∏–¥–µ–æ—Å–≤—è–∑–∏</p>
                                    </div>
                                </label>
                                
                                <label class="relative flex items-center p-4 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                    <input 
                                        type="checkbox" 
                                        name="format_offline" 
                                        value="true"
                                        x-model="formData.format_offline"
                                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                        hx-trigger="change"
                                        hx-target="#location-fields"
                                        hx-swap="innerHTML"
                                        hx-get="/fragments/location_fields/"
                                    />
                                    <div class="ml-3">
                                        <div class="flex items-center">
                                            <i data-lucide="map-pin" class="w-5 h-5 text-green-600 mr-2"></i>
                                            <span class="font-medium text-gray-900 dark:text-white">–û—á–Ω–æ</span>
                                        </div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">–õ–∏—á–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Location (conditionally shown) -->
                        <div id="location-fields"></div>

                        <!-- Schedule -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                –ñ–µ–ª–∞–µ–º–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-2">–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
                                    <select 
                                        name="schedule_days" 
                                        multiple
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    >
                                        <option value="monday">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
                                        <option value="tuesday">–í—Ç–æ—Ä–Ω–∏–∫</option>
                                        <option value="wednesday">–°—Ä–µ–¥–∞</option>
                                        <option value="thursday">–ß–µ—Ç–≤–µ—Ä–≥</option>
                                        <option value="friday">–ü—è—Ç–Ω–∏—Ü–∞</option>
                                        <option value="saturday">–°—É–±–±–æ—Ç–∞</option>
                                        <option value="sunday">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 dark:text-gray-400 mb-2">–í—Ä–µ–º—è</label>
                                    <select 
                                        name="schedule_time"
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    >
                                        <option value="">–õ—é–±–æ–µ –≤—Ä–µ–º—è</option>
                                        <option value="morning">–£—Ç—Ä–æ–º (9:00-12:00)</option>
                                        <option value="afternoon">–î–Ω–µ–º (12:00-17:00)</option>
                                        <option value="evening">–í–µ—á–µ—Ä–æ–º (17:00-21:00)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- AI Matching Option -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-6 border border-blue-200 dark:border-blue-800">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <i data-lucide="zap" class="w-4 h-4 text-white"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="flex items-center">
                                        <input 
                                            type="checkbox" 
                                            id="use_ai_matching" 
                                            name="use_ai_matching"
                                            value="true"
                                            x-model="formData.use_ai_matching"
                                            checked
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                        />
                                        <label for="use_ai_matching" class="ml-2 text-lg font-medium text-gray-900 dark:text-white">
                                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ò–ò-–ø–æ–¥–±–æ—Ä —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤
                                        </label>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                        –ò–ò –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, 
                                        —É—á–∏—Ç—ã–≤–∞—è –æ–ø—ã—Ç, —Ä–µ–π—Ç–∏–Ω–≥ –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8">
                        <button 
                            type="button"
                            @click="currentStep = 3"
                            class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors flex items-center space-x-2"
                        >
                            <i data-lucide="arrow-left" class="w-4 h-4"></i>
                            <span>–ù–∞–∑–∞–¥</span>
                        </button>
                        
                        <div class="flex items-center space-x-4">
                            <div id="loading" class="htmx-indicator">
                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                                    –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...
                                </div>
                            </div>
                            
                            <button 
                                type="submit"
                                class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center space-x-2"
                            >
                                <i data-lucide="check" class="w-4 h-4"></i>
                                <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- AI Matching Results Modal -->
<div id="ai-matching-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-96 overflow-hidden">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4">
                        <i data-lucide="zap" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">–ò–ò –Ω–∞—à–µ–ª –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤</h3>
                </div>
                <button onclick="closeAIModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="ai-results-container" class="space-y-4 max-h-80 overflow-y-auto">
                <!-- AI results will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Form validation
    document.getElementById('budget_max').addEventListener('input', function() {
        const minBudget = parseInt(document.getElementById('budget_min').value);
        const maxBudget = parseInt(this.value);
        
        if (maxBudget && minBudget && maxBudget < minBudget) {
            this.setCustomValidity('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ');
        } else {
            this.setCustomValidity('');
        }
    });

    // Handle successful order creation
    document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful && event.detail.xhr.status === 201) {
            const response = JSON.parse(event.detail.xhr.responseText);
            const useAI = document.getElementById('use_ai_matching').checked;
            
            if (useAI) {
                // Show AI matching results
                loadAIMatches(response.id);
            } else {
                // Redirect to order page
                window.location.href = `/orders/${response.id}/`;
            }
        }
    });

    // Load AI matches
    function loadAIMatches(orderId) {
        document.getElementById('ai-matching-modal').classList.remove('hidden');
        
        fetch('/api/ml/match/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                order_id: orderId,
                limit: 5
            })
        })
        .then(response => response.json())
        .then(data => {
            displayAIResults(data.matches, orderId);
        })
        .catch(error => {
            console.error('AI matching failed:', error);
            closeAIModal();
            showNotification('–ò–ò-–ø–æ–¥–±–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
        });
    }

    // Display AI results
    function displayAIResults(matches, orderId) {
        const container = document.getElementById('ai-results-container');
        
        if (!matches || matches.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i data-lucide="search" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">–ò–ò –Ω–µ –Ω–∞—à–µ–ª –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞.</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        container.innerHTML = matches.map(match => `
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-medium">
                                ${match.profile.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white">${match.profile.name}</h4>
                                <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center">
                                        <i data-lucide="star" class="w-4 h-4 text-yellow-500 mr-1"></i>
                                        ${match.profile.rating}/5
                                    </span>
                                    <span class="flex items-center">
                                        <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                                        ${match.profile.experience_years} –ª–µ—Ç –æ–ø—ã—Ç–∞
                                    </span>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                ${Math.round(match.score * 100)}% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                            </span>
                        </div>
                        <div class="mt-3">
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                <strong>–ü–æ—á–µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç:</strong> ${match.reasons.join(', ')}
                            </p>
                        </div>
                    </div>
                    <div class="flex flex-col items-end space-y-3">
                        <button 
                            onclick="inviteTutor(${match.tutor_id}, ${orderId})"
                            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white text-sm rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all flex items-center space-x-2"
                        >
                            <i data-lucide="send" class="w-4 h-4"></i>
                            <span>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</span>
                        </button>
                        <a href="/tutors/${match.tutor_id}/" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm flex items-center space-x-1">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                        </a>
                    </div>
                </div>
            </div>
        `).join('');
        
        lucide.createIcons();
    }

    // Close AI modal
    function closeAIModal() {
        document.getElementById('ai-matching-modal').classList.add('hidden');
        // Redirect to orders list
        window.location.href = '/orders/';
    }

    // Invite tutor
    function inviteTutor(tutorId, orderId) {
        // This would send an invitation to the tutor
        showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—É!', 'success');
    }
</script>
{% endblock %}